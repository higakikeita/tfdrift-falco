name: Benchmark Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  benchmark:
    name: Benchmark Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comparison

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks (current)
        run: |
          cd tests/benchmark
          go test -bench=. -benchmem -benchtime=10s -count=5 | tee current.txt

      - name: Run benchmarks (base) for PR
        if: github.event_name == 'pull_request'
        run: |
          git checkout ${{ github.event.pull_request.base.sha }}
          cd tests/benchmark
          go test -bench=. -benchmem -benchtime=10s -count=5 | tee base.txt
          git checkout -

      - name: Compare benchmarks
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          cd tests/benchmark
          if [ -f base.txt ] && [ -f current.txt ]; then
            benchstat base.txt current.txt > comparison.txt || true
            echo "comparison_exists=true" >> $GITHUB_OUTPUT
          else
            echo "comparison_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for performance degradation
        if: github.event_name == 'pull_request' && steps.compare.outputs.comparison_exists == 'true'
        id: check_degradation
        run: |
          cd tests/benchmark

          # Parse benchstat output for significant regressions (>20% slower)
          if grep -E '\+[2-9][0-9]\.[0-9]+%|^\+[1][0-9]{2,}\.[0-9]+%' comparison.txt; then
            echo "degradation=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Performance degradation detected (>20% slower)"
          else
            echo "degradation=false" >> $GITHUB_OUTPUT
            echo "âœ… No significant performance degradation"
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: tests/benchmark/*.txt
          retention-days: 30

      - name: Comment PR with benchmark results
        if: github.event_name == 'pull_request' && steps.compare.outputs.comparison_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comparison = '';
            let current = '';
            let degradation = '${{ steps.check_degradation.outputs.degradation }}' === 'true';

            try {
              comparison = fs.readFileSync('tests/benchmark/comparison.txt', 'utf8');
              current = fs.readFileSync('tests/benchmark/current.txt', 'utf8');
            } catch (e) {
              comparison = 'Could not read benchmark results';
            }

            let summary = '## ðŸ“Š Benchmark Results\n\n';

            if (degradation) {
              summary += 'âš ï¸ **Performance degradation detected (>20% slower)**\n\n';
              summary += 'Please review the changes to ensure performance is acceptable.\n\n';
            } else {
              summary += 'âœ… **No significant performance degradation detected**\n\n';
            }

            summary += '### Comparison vs Base Branch\n\n';
            summary += '```\n';
            summary += comparison;
            summary += '\n```\n\n';

            // Extract key metrics from current run
            const benchLines = current.split('\n').filter(line =>
              line.includes('Benchmark') && !line.includes('=== RUN')
            ).slice(0, 10);

            if (benchLines.length > 0) {
              summary += '### Current Performance Metrics\n\n';
              summary += '```\n';
              summary += benchLines.join('\n');
              summary += '\n```\n\n';
            }

            summary += '### About Benchmarks\n\n';
            summary += 'These benchmarks measure:\n';
            summary += '- **Event processing throughput** (events/sec)\n';
            summary += '- **Memory allocations** (bytes/op, allocs/op)\n';
            summary += '- **State comparison performance**\n';
            summary += '- **Drift detection for EC2, IAM, S3**\n';
            summary += '- **Concurrent event handling**\n\n';
            summary += 'Performance targets:\n';
            summary += '- âœ… >5,000 events/sec single-threaded\n';
            summary += '- âœ… <10KB memory per event\n';
            summary += '- âœ… Linear scaling with concurrent workloads\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Fail if performance degraded
        if: github.event_name == 'pull_request' && steps.check_degradation.outputs.degradation == 'true'
        run: |
          echo "::warning::Performance degradation detected. Please review benchmark results."
          # Don't fail the build, just warn
          exit 0

  benchmark-baseline:
    name: Update Benchmark Baseline
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run benchmarks
        run: |
          cd tests/benchmark
          go test -bench=. -benchmem -benchtime=10s -count=5 | tee baseline-${{ github.sha }}.txt

      - name: Upload baseline
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-baseline-${{ github.sha }}
          path: tests/benchmark/baseline-*.txt
          retention-days: 90

      - name: Commit baseline to repo
        run: |
          mkdir -p .github/benchmark-baselines
          cp tests/benchmark/baseline-${{ github.sha }}.txt .github/benchmark-baselines/latest.txt

          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .github/benchmark-baselines/latest.txt
            git commit -m "chore: update benchmark baseline [skip ci]"
            git push
          fi
