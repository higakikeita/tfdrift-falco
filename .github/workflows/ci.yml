name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]
  schedule:
    # Run security scans every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  security-events: write
  actions: read
  pull-requests: write

env:
  GO_VERSION: '1.24'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Detect changed files
  # ============================================
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - '**.go'
              - 'go.mod'
              - 'go.sum'
              - 'cmd/**'
              - 'pkg/**'
              - 'tests/**'
              - '.github/workflows/ci.yml'
            frontend:
              - 'ui/**'
              - '.github/workflows/ci.yml'

  # ============================================
  # Backend: Go Build, Lint, and Test
  # ============================================
  backend:
    name: Backend
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      # ===== Lint (from lint.yml) =====
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        continue-on-error: true
        with:
          version: latest
          args: --timeout=5m

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "âŒ Go files must be formatted with gofmt. Please run:"
            echo "  gofmt -w ."
            gofmt -l .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          staticcheck ./...
        continue-on-error: true

      - name: Check go mod tidy
        run: |
          go mod tidy
          if [ -n "$(git status --porcelain go.mod go.sum)" ]; then
            echo "âŒ go.mod or go.sum is not up to date. Please run:"
            echo "  go mod tidy"
            git diff go.mod go.sum
            exit 1
          fi

      # ===== Test (from test.yml) =====
      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        continue-on-error: true

      - name: Generate coverage report
        run: go tool cover -func=coverage.out

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

      # ===== Build =====
      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux go build \
            -ldflags="-s -w -X main.version=${{ github.ref_name }}" \
            -o tfdrift \
            ./cmd/tfdrift

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfdrift-binary
          path: tfdrift
          retention-days: 7

  # ============================================
  # Frontend: UI Build, Lint, and Test
  # ============================================
  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    defaults:
      run:
        working-directory: ./ui

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install dependencies
        run: npm ci

      # ===== Lint =====
      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Run TypeScript compiler
        run: npx tsc -b --noEmit
        continue-on-error: true

      # ===== Test =====
      - name: Run unit tests
        run: npm test -- --passWithNoTests
        continue-on-error: true

      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./ui/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      # ===== Build =====
      - name: Build for production
        run: npm run build
        continue-on-error: true
        env:
          NODE_ENV: production

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ui/dist
          retention-days: 7

  # ============================================
  # Docker Build and Push
  # ============================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name == 'release'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (backend)
        id: meta-backend
        uses: docker/metadata-action@v5
        continue-on-error: true
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/tfdrift-falco
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        continue-on-error: true
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name == 'release' }}
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Extract metadata (frontend)
        id: meta-frontend
        uses: docker/metadata-action@v5
        continue-on-error: true
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/tfdrift-frontend
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        continue-on-error: true
        with:
          context: ./ui
          file: ./ui/Dockerfile
          push: ${{ github.event_name == 'release' }}
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ============================================
  # Integration Tests
  # ============================================
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [changes, backend]
    if: |
      github.event_name == 'workflow_dispatch' ||
      (needs.changes.outputs.backend == 'true' && (github.event_name == 'push' || github.event_name == 'pull_request'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run integration tests
        run: |
          cd tests/integration
          # Check if there are active test files (not build-ignored)
          go list -f '{{.TestGoFiles}}' ./... | grep -q "\[.*\]"
          if [ $? -eq 0 ]; then
            go test -v -race -coverprofile=integration-coverage.out ./...
          else
            echo "â„¹ï¸  Integration tests are disabled (build tags: ignore)"
            echo "These tests require external services (Slack, Grafana, etc.)"
            echo "Skipping..."
            # Create empty coverage file to satisfy next step
            touch integration-coverage.out
            exit 0
          fi

      - name: Generate integration coverage report
        run: |
          cd tests/integration
          if [ -s integration-coverage.out ]; then
            go tool cover -func=integration-coverage.out
          else
            echo "No coverage data to report"
          fi

      - name: Upload integration coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./tests/integration/integration-coverage.out
          flags: integration
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Run integration tests for summary
        if: github.event_name == 'pull_request'
        run: |
          cd tests/integration
          go test -v ./... 2>&1 | tee integration-results.txt
        continue-on-error: true

      - name: Comment PR with integration test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let results = '';
            try {
              results = fs.readFileSync('tests/integration/integration-results.txt', 'utf8');
            } catch (e) {
              results = 'Could not read test results';
            }

            // Parse test results
            const passMatch = results.match(/PASS/g);
            const failMatch = results.match(/FAIL/g);
            const passCount = passMatch ? passMatch.length : 0;
            const failCount = failMatch ? failMatch.length : 0;

            // Extract test names
            const testLines = results.split('\n').filter(line =>
              line.includes('=== RUN') || line.includes('--- PASS') || line.includes('--- FAIL')
            );

            let summary = '## ðŸ”— Integration Test Results\n\n';

            if (failCount === 0) {
              summary += 'âœ… **All integration tests passed!**\n\n';
            } else {
              summary += 'âŒ **Some integration tests failed**\n\n';
            }

            summary += `- Passed: ${passCount}\n`;
            summary += `- Failed: ${failCount}\n\n`;

            if (testLines.length > 0) {
              summary += '### Test Details\n\n';
              summary += '```\n';
              summary += testLines.slice(0, 20).join('\n'); // First 20 lines
              if (testLines.length > 20) {
                summary += '\n... (truncated)\n';
              }
              summary += '\n```\n';
            }

            summary += '\n### What are Integration Tests?\n\n';
            summary += 'Integration tests validate component interactions with mocked external dependencies:\n';
            summary += '- Slack/Discord webhook notifications\n';
            summary += '- Falco gRPC event parsing\n';
            summary += '- State loading and comparison\n';
            summary += '- No real AWS or Falco required\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # ============================================
  # Security Scans
  # ============================================
  security-snyk:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (needs.changes.outputs.backend == 'true' && github.event_name != 'pull_request') ||
      (needs.changes.outputs.backend == 'true' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/golang@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk.sarif --file=go.mod
          command: test

      - name: Upload Snyk results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  security-gosec:
    name: GoSec Security Scanner
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: changes
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (needs.changes.outputs.backend == 'true' && (github.event_name == 'push' || github.event_name == 'pull_request'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        continue-on-error: true
        with:
          args: '-fmt sarif -out gosec.sarif -exclude-generated ./...'

      - name: Upload Gosec results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec.sarif

  security-nancy:
    name: Nancy Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: changes
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (needs.changes.outputs.backend == 'true' && (github.event_name == 'push' || github.event_name == 'pull_request'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Write Go List
        run: go list -json -deps ./... > go.list

      - name: Run Nancy
        uses: sonatype-nexus-community/nancy-github-action@main
        continue-on-error: true

  # ============================================
  # Benchmark Tests
  # ============================================
  benchmark:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    needs: [changes, backend]
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'benchmark'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comparison

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks (current)
        run: |
          cd tests/benchmark
          go test -bench=. -benchmem -benchtime=10s -count=5 | tee current.txt

      - name: Run benchmarks (base) for PR
        if: github.event_name == 'pull_request'
        run: |
          git checkout ${{ github.event.pull_request.base.sha }}
          cd tests/benchmark
          go test -bench=. -benchmem -benchtime=10s -count=5 | tee base.txt
          git checkout -

      - name: Compare benchmarks
        if: github.event_name == 'pull_request'
        id: compare
        run: |
          cd tests/benchmark
          if [ -f base.txt ] && [ -f current.txt ]; then
            benchstat base.txt current.txt > comparison.txt || true
            echo "comparison_exists=true" >> $GITHUB_OUTPUT
          else
            echo "comparison_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for performance degradation
        if: github.event_name == 'pull_request' && steps.compare.outputs.comparison_exists == 'true'
        id: check_degradation
        run: |
          cd tests/benchmark

          # Parse benchstat output for significant regressions (>20% slower)
          if grep -E '\+[2-9][0-9]\.[0-9]+%|^\+[1][0-9]{2,}\.[0-9]+%' comparison.txt; then
            echo "degradation=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Performance degradation detected (>20% slower)"
          else
            echo "degradation=false" >> $GITHUB_OUTPUT
            echo "âœ… No significant performance degradation"
          fi

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: tests/benchmark/*.txt
          retention-days: 30

      - name: Comment PR with benchmark results
        if: github.event_name == 'pull_request' && steps.compare.outputs.comparison_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comparison = '';
            let current = '';
            let degradation = '${{ steps.check_degradation.outputs.degradation }}' === 'true';

            try {
              comparison = fs.readFileSync('tests/benchmark/comparison.txt', 'utf8');
              current = fs.readFileSync('tests/benchmark/current.txt', 'utf8');
            } catch (e) {
              comparison = 'Could not read benchmark results';
            }

            let summary = '## ðŸ“Š Benchmark Results\n\n';

            if (degradation) {
              summary += 'âš ï¸ **Performance degradation detected (>20% slower)**\n\n';
              summary += 'Please review the changes to ensure performance is acceptable.\n\n';
            } else {
              summary += 'âœ… **No significant performance degradation detected**\n\n';
            }

            summary += '### Comparison vs Base Branch\n\n';
            summary += '```\n';
            summary += comparison;
            summary += '\n```\n\n';

            // Extract key metrics from current run
            const benchLines = current.split('\n').filter(line =>
              line.includes('Benchmark') && !line.includes('=== RUN')
            ).slice(0, 10);

            if (benchLines.length > 0) {
              summary += '### Current Performance Metrics\n\n';
              summary += '```\n';
              summary += benchLines.join('\n');
              summary += '\n```\n\n';
            }

            summary += '### About Benchmarks\n\n';
            summary += 'These benchmarks measure:\n';
            summary += '- **Event processing throughput** (events/sec)\n';
            summary += '- **Memory allocations** (bytes/op, allocs/op)\n';
            summary += '- **State comparison performance**\n';
            summary += '- **Drift detection for EC2, IAM, S3**\n';
            summary += '- **Concurrent event handling**\n\n';
            summary += 'Performance targets:\n';
            summary += '- âœ… >5,000 events/sec single-threaded\n';
            summary += '- âœ… <10KB memory per event\n';
            summary += '- âœ… Linear scaling with concurrent workloads\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Warn if performance degraded
        if: github.event_name == 'pull_request' && steps.check_degradation.outputs.degradation == 'true'
        run: |
          echo "::warning::Performance degradation detected. Please review benchmark results."
          exit 0

      - name: Update benchmark baseline (main branch only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cd tests/benchmark
          cp current.txt baseline-${{ github.sha }}.txt

      - name: Upload baseline
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-baseline-${{ github.sha }}
          path: tests/benchmark/baseline-*.txt
          retention-days: 90

      - name: Commit baseline to repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p .github/benchmark-baselines
          cp tests/benchmark/baseline-${{ github.sha }}.txt .github/benchmark-baselines/latest.txt

          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .github/benchmark-baselines/latest.txt
            git commit -m "chore: update benchmark baseline [skip ci]"
            git push
          fi
