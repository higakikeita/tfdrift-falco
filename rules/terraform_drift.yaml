# Falco Rules for Terraform Drift Detection (Simplified)
# These rules detect manual changes to Terraform-managed AWS resources

- rule: AWS EC2 Modification
  desc: Detect EC2 instance modifications
  condition: >
    ct.name in ("ModifyInstanceAttribute", "StartInstances", "StopInstances",
    "TerminateInstances", "RebootInstances")
  output: >
    AWS EC2 modification detected (event=%ct.name user=%ct.user.identity.principalid region=%ct.region)
  priority: WARNING
  source: aws_cloudtrail
  tags: [terraform, drift, ec2]

- rule: AWS S3 Bucket Modification
  desc: Detect S3 bucket configuration changes
  condition: >
    ct.name in ("PutBucketPolicy", "DeleteBucketPolicy", "PutBucketEncryption",
    "DeleteBucketEncryption", "PutBucketVersioning")
  output: >
    AWS S3 bucket modified (event=%ct.name user=%ct.user.identity.principalid)
  priority: WARNING
  source: aws_cloudtrail
  tags: [terraform, drift, s3]

- rule: AWS IAM Modification
  desc: Detect IAM policy and role changes
  condition: >
    ct.name in ("PutRolePolicy", "DeleteRolePolicy", "UpdateAssumeRolePolicy",
    "PutUserPolicy", "DeleteUserPolicy", "CreateRole", "DeleteRole")
  output: >
    AWS IAM modification detected (event=%ct.name user=%ct.user.identity.principalid)
  priority: CRITICAL
  source: aws_cloudtrail
  tags: [terraform, drift, iam, security]

- rule: AWS Security Group Modification
  desc: Detect security group rule changes
  condition: >
    ct.name in ("AuthorizeSecurityGroupIngress", "RevokeSecurityGroupIngress",
    "AuthorizeSecurityGroupEgress", "RevokeSecurityGroupEgress",
    "CreateSecurityGroup", "DeleteSecurityGroup")
  output: >
    AWS Security Group modified (event=%ct.name user=%ct.user.identity.principalid region=%ct.region)
  priority: WARNING
  source: aws_cloudtrail
  tags: [terraform, drift, security, network]

- rule: AWS RDS Modification
  desc: Detect RDS instance modifications
  condition: >
    ct.name in ("ModifyDBInstance", "DeleteDBInstance", "CreateDBInstance",
    "ModifyDBCluster", "DeleteDBCluster")
  output: >
    AWS RDS modification detected (event=%ct.name user=%ct.user.identity.principalid region=%ct.region)
  priority: WARNING
  source: aws_cloudtrail
  tags: [terraform, drift, rds, database]

- rule: AWS Lambda Function Modification
  desc: Detect Lambda function changes
  condition: >
    ct.name in ("UpdateFunctionCode", "UpdateFunctionConfiguration",
    "DeleteFunction", "CreateFunction")
  output: >
    AWS Lambda modification detected (event=%ct.name user=%ct.user.identity.principalid region=%ct.region)
  priority: WARNING
  source: aws_cloudtrail
  tags: [terraform, drift, lambda]
