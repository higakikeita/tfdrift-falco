# ãªãœFalcoãªã®ã‹ - åœ°å›³ã¨ç›®æ’ƒè€…ã®ç‰©èª

## ã¯ã˜ã‚ã«

[TFDrift-Falco](https://github.com/higakikeita/tfdrift-falco) ã¯ã€Falco ã‚’ä½¿ã£ã¦ Terraform ã®ãƒ‰ãƒªãƒ•ãƒˆï¼ˆçŠ¶æ…‹ã®ã‚ºãƒ¬ï¼‰ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«æ¤œçŸ¥ã™ã‚‹ OSS ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

ã—ã‹ã—ã€ãªãœã€ŒFalcoã€ã‚’é–“ã«æŒŸã‚€å¿…è¦ãŒã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
Terraform ã ã‘ã§ã¯ãƒ€ãƒ¡ãªã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã“ã®å•ã„ã«ç­”ãˆã‚‹ãŸã‚ã€æŠ€è¡“çš„ãªèª¬æ˜ã®å‰ã«ã€ä¸€ã¤ã®ç‰©èªã‹ã‚‰ãŠè©±ã—ã—ã¾ã™ã€‚

---

## ğŸ“– ç‰©èªï½œã€Œåœ°å›³ã€ã¨ã€Œç›®æ’ƒè€…ã€

### ç¬¬1ç« ï¼šå®Œç’§ãªåœ°å›³ã‚’æŒã¤è¡—

ã‚ã‚‹è¡—ã«ã¯ã€ã¨ã¦ã‚‚å„ªç§€ãªè¨­è¨ˆå£«ãŒã„ã¾ã—ãŸã€‚
å½¼ã¯è¡—ã®ã™ã¹ã¦ã‚’ **åœ°å›³ï¼ˆTerraformï¼‰** ã«æ›¸ãã¾ã—ãŸã€‚

- å®¶ã¯ã“ã“
- é“è·¯ã¯ã“ã†
- é–€ã¯ã“ã®å¤§ãã•
- éµã¯ã“ã®æ•°

ãã®åœ°å›³ã¯å®Œç’§ã§ã—ãŸã€‚
èª°ãŒè¦‹ã¦ã‚‚ã€Œç†æƒ³ã®è¡—ã€ã§ã—ãŸã€‚

### ç¬¬2ç« ï¼šåœ°å›³ã¯"ä»Š"ã‚’èªã‚‰ãªã„

ã¨ã“ã‚ãŒã‚ã‚‹æ—¥ã€å•é¡ŒãŒèµ·ãã¾ã™ã€‚

- å¤œä¸­ã«èª°ã‹ãŒé–€ã‚’ä»˜ã‘æ›¿ãˆãŸ
- æœã«ã¯éµãŒä¸€ã¤å¢—ãˆã¦ã„ãŸ
- ã§ã‚‚åœ°å›³ã¯â€¦ ä½•ã‚‚å¤‰ã‚ã£ã¦ã„ãªã„

è¨­è¨ˆå£«ã¯è¨€ã„ã¾ã™ã€‚

> ã€ŒãŠã‹ã—ã„ã€‚åœ°å›³ã§ã¯ã€ãã‚“ãªå¤‰æ›´ã¯ã—ã¦ã„ãªã„ã¯ãšã ã€

å½¼ã¯ç¿Œæœã€è¡—ã‚’æ­©ã„ã¦å›ã‚Šã€åœ°å›³ã¨ç¾å®Ÿã‚’è¦‹æ¯”ã¹ã¾ã—ãŸã€‚

ãã—ã¦ã‚ˆã†ã‚„ãæ°—ã¥ãã¾ã™ã€‚

> ã€Œâ€¦â€¦ã‚ã€å¤‰ã‚ã£ã¦ã‚‹ã€

### ç¬¬3ç« ï¼šã§ã‚‚é…ã™ããŸ

è¨­è¨ˆå£«ã¯ã‚ã‹ã‚Šã¾ã—ãŸã€‚

âœ… ä½•ãŒå¤‰ã‚ã£ãŸã‹
âœ… ã©ã“ãŒé•ã†ã‹

ã§ã‚‚ã€åˆ†ã‹ã‚‰ãªã„ã“ã¨ãŒå¤šã™ãã¾ã—ãŸã€‚

â“ **èª°ãŒã‚„ã£ãŸã®ã‹**
â“ **ã„ã¤ã‚„ã£ãŸã®ã‹**
â“ **ãªãœã‚„ã£ãŸã®ã‹**

åœ°å›³ã¯ã€Œçµæœã€ã—ã‹èªã‚‰ãªã„ã€‚
**è¡Œç‚ºã®ç¬é–“** ã¯ã€ã©ã“ã«ã‚‚æ›¸ã„ã¦ã„ãªã„ã®ã§ã™ã€‚

### ç¬¬4ç« ï¼šç›®æ’ƒè€…ã®ç™»å ´

ãã“ã§è¡—ã¯ã€ã‚ã‚‹äººç‰©ã‚’é›‡ã„ã¾ã—ãŸã€‚

ãã‚ŒãŒ **Falco**ã€‚
å½¼ã¯è¨­è¨ˆå£«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
è­¦å¯Ÿã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚

ãŸã ã® **"ç›®æ’ƒè€…"** ã§ã™ã€‚

### ç¬¬5ç« ï¼šFalcoã®ä»•äº‹

Falco ã¯ã€è¡—ã‚’ä½œã‚Šã¾ã›ã‚“ã€‚
åœ°å›³ã‚‚å¼•ãã¾ã›ã‚“ã€‚

å½¼ãŒã‚„ã‚‹ã®ã¯ã€ãŸã£ãŸä¸€ã¤ã€‚

> **ã€Œèª°ã‹ãŒ"ä½•ã‹ã‚’ã—ãŸç¬é–“"ã‚’è¦‹ã‚‹ã“ã¨ã€**

- èª°ãŒ
- ã„ã¤
- ã©ã®é–€ã«
- ã©ã‚“ãªæ‰‹ã‚’ä¼¸ã°ã—ãŸã‹

å¤‰ã‚ã£ãŸ"ã‚ã¨"ã§ã¯ãªãã€
**å¤‰ãˆã‚ˆã†ã¨ã—ãŸ"ç¬é–“"** ã‚’è¦‹ã‚‹ã€‚

### ç¬¬6ç« ï¼šã‚ã‚‹å¤œã®å‡ºæ¥äº‹

çœŸå¤œä¸­ã€‚
è¡—ãŒçœ ã£ã¦ã„ã‚‹æ™‚é–“ã€‚

Falco ã¯è¦‹ã¾ã—ãŸã€‚

- è¦‹æ…£ã‚Œãªã„äººç‰©ãŒ
- æœ¬æ¥ä½¿ã‚ãªã„é“ã‹ã‚‰
- é–€ã®éµã«æ‰‹ã‚’ã‹ã‘ãŸç¬é–“ã‚’

ãã®ç¬é–“ã€Falco ã¯å«ã³ã¾ã™ã€‚

> ã€Œä»Šã ã€‚ã“ã‚Œã¯"ã„ã¤ã‚‚ã®è¡—"ã˜ã‚ƒãªã„ã€

### ç¬¬7ç« ï¼šåœ°å›³ã¨ç›®æ’ƒè€…ãŒå‡ºä¼šã†

è¨­è¨ˆå£«ã¯ã€Falco ã®è©±ã‚’èãã¾ã™ã€‚

> ã€Œèª°ãŒã€ã„ã¤ã€ã©ã“ã‚’è§¦ã£ãŸï¼Ÿã€

è¨­è¨ˆå£«ã¯åœ°å›³ã‚’é–‹ãã¾ã™ã€‚

> ã€Œãã®å¤‰æ›´ã¯â€¦â€¦åœ°å›³ã«ã¯å­˜åœ¨ã—ãªã„ã€

ãã®ç¬é–“ã€2äººã¯ç†è§£ã—ã¾ã™ã€‚

### ç¬¬8ç« ï¼šå½¹å‰²ã®é•ã„

**åœ°å›³ï¼ˆTerraformï¼‰**
â†’ ã€Œã‚ã‚‹ã¹ãå§¿ã€ã‚’çŸ¥ã£ã¦ã„ã‚‹

**ç›®æ’ƒè€…ï¼ˆFalcoï¼‰**
â†’ ã€Œå®Ÿéš›ã«èµ·ããŸè¡Œç‚ºã€ã‚’çŸ¥ã£ã¦ã„ã‚‹

ã©ã¡ã‚‰ã‹ä¸€æ–¹ã§ã¯ã€è¡—ã¯å®ˆã‚Œãªã„ã€‚

### ç¬¬9ç« ï¼šãªãœFalcoãªã®ã‹

Falco ãŒç‰¹åˆ¥ãªã®ã¯ã€
**çµæœã§ã¯ãªã"è¡Œç‚º"ã‚’èªã‚‹ã‹ã‚‰**ã€‚

- çŠ¶æ…‹ã§ã¯ãªãã€**å‹•ä½œ**
- å·®åˆ†ã§ã¯ãªãã€**æ„å›³**
- ãƒªã‚½ãƒ¼ã‚¹ã§ã¯ãªãã€**äºº**

ã ã‹ã‚‰ Falco ã¯è¨€ãˆã‚‹ã€‚

> ã€Œã“ã®è¡—ã§"ä½•ãŒèµ·ããŸã‹"ã§ã¯ãªãã€**"ãªãœèµ·ããŸã‹"**ã‚’ã€

### æœ€çµ‚ç« ï¼šç¾ä»£ã®è¡—ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰

ä»Šã®è¡—ã¯ã€äººé–“ã ã‘ã§ä½œã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

- Bot
- CI/CD
- è‡ªå‹•åŒ–
- AI Agent

å¤‰æ›´ã¯ä¸€ç¬ã§èµ·ãã‚‹ã€‚

ã ã‹ã‚‰ã“ãå¿…è¦ãªã®ã¯ã€

**å¾Œã‹ã‚‰è¦‹ã‚‹ç›£æŸ»ã§ã¯ãªãã€ãã®ç¬é–“ã‚’è¦‹ã¦ã„ãŸå­˜åœ¨**

---

## ğŸ§  ã“ã®ç‰©èªã‚’ä¸€æ–‡ã§

> **Terraform ã¯åœ°å›³ã‚’æãã€‚**
> **Falco ã¯ç¾å ´ã‚’è¦‹ã¦ã„ã‚‹ã€‚**

ã ã‹ã‚‰ã€

> **Falco ã‚’æŒŸã‚€ã¨ã¯ã€ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ã«"ç›®æ’ƒè€…"ã‚’ç½®ãã“ã¨ã€**

---

## ğŸ”§ æŠ€è¡“çš„ãªèƒŒæ™¯

### å¾“æ¥ã®ãƒ‰ãƒªãƒ•ãƒˆæ¤œçŸ¥

ä¸€èˆ¬çš„ãªãƒ‰ãƒªãƒ•ãƒˆæ¤œçŸ¥ãƒ„ãƒ¼ãƒ«ï¼ˆdriftctl ãªã©ï¼‰ã¯ï¼š

```bash
# å®šæœŸçš„ã«ã‚¹ã‚­ãƒ£ãƒ³
terraform plan
driftctl scan
```

**è¦‹ã¦ã„ã‚‹ã‚‚ã®:**
- âœ… ä½•ãŒå¤‰ã‚ã£ãŸã‹ï¼ˆçµæœï¼‰
- âŒ èª°ãŒ / ã„ã¤ / ãªãœ å¤‰ãˆãŸã‹ï¼ˆåŸå› ï¼‰

ğŸ‘‰ ã€Œäº‹æ•…å¾Œã®å¥åº·è¨ºæ–­ã€ã«è¿‘ã„

### Falco ã‚’æŒŸã‚€ã¨

TFDrift-Falco ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼š

```
IAM User ãŒ API ã‚’å©ã„ãŸ
  â†“
CloudTrail / Audit Log
  â†“
Falco ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’å³æ™‚æ¤œçŸ¥
  â†“
Terraform State ã¨æ¯”è¼ƒ
  â†“
å³åº§ã«ã‚¢ãƒ©ãƒ¼ãƒˆ
```

**è¦‹ã¦ã„ã‚‹ã‚‚ã®:**
- âœ… èª°ãŒï¼ˆIAM Userã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
- âœ… ã„ã¤ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
- âœ… ãªãœï¼ˆAPI ã‚¤ãƒ™ãƒ³ãƒˆåã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰
- âœ… ä½•ã‚’ï¼ˆãƒªã‚½ãƒ¼ã‚¹å¤‰æ›´ï¼‰

ğŸ‘‰ ã€Œå¤‰æ›´ã•ã‚Œã‚‹ç¬é–“ã€ã‚’æ‰ãˆã‚‹

---

## ğŸ“Š æ¯”è¼ƒè¡¨

| è¦³ç‚¹ | å¾“æ¥ã®ãƒ‰ãƒªãƒ•ãƒˆæ¤œçŸ¥ | Falco + TFDrift |
|------|-------------------|-----------------|
| **æ¤œçŸ¥å¯¾è±¡** | å·®åˆ†ï¼ˆçµæœï¼‰ | è¡Œç‚ºï¼ˆåŸå› ï¼‰ |
| **ä¸»èª** | ãƒªã‚½ãƒ¼ã‚¹ | äºº / Role / Bot |
| **æ™‚é–“** | é…å»¶ï¼ˆå®šæœŸã‚¹ã‚­ãƒ£ãƒ³ï¼‰ | ã»ã¼ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹å®š** | å›°é›£ | CloudTrail ã‹ã‚‰å–å¾— |
| **æ¤œçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°** | å¤‰æ›´å¾Œ | å¤‰æ›´ã®ç¬é–“ |

---

## ğŸ¯ å®Ÿç”¨ä¾‹

### ã‚±ãƒ¼ã‚¹1ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åã®å³åº§æ¤œçŸ¥

**ã‚·ãƒŠãƒªã‚ª:**
é–‹ç™ºè€…ãŒæœ¬ç•ªç’°å¢ƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ AWS Console ã‹ã‚‰æ‰‹å‹•å¤‰æ›´

**å¾“æ¥ã®ãƒ‰ãƒªãƒ•ãƒˆæ¤œçŸ¥:**
```bash
# ç¿Œæ—¥ã®å®šæœŸã‚¹ã‚­ãƒ£ãƒ³ã§ç™ºè¦‹
$ terraform plan
# "security_groups" ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™
```
- âŒ èª°ãŒå¤‰æ›´ã—ãŸã‹ä¸æ˜
- âŒ ã„ã¤å¤‰æ›´ã•ã‚ŒãŸã‹ä¸æ˜
- âŒ ãªãœå¤‰æ›´ã—ãŸã‹ä¸æ˜

**TFDrift-Falco:**
```
[2025-01-15 14:32:10] ALERT Drift Detected!
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Resource:     aws_security_group.web
Type:         Manual Modification

Changed Attribute:
  ingress.0.cidr_blocks: ["10.0.0.0/8"] â†’ ["0.0.0.0/0"]

Context:
  User:         developer@example.com
  Source:       AWS Console (IAM User)
  IP Address:   203.0.113.42
  Region:       ap-northeast-1
  Timestamp:    2025-01-15T14:32:08Z

CloudTrail:
  EventID:      a1b2c3d4-...
  EventName:    AuthorizeSecurityGroupIngress

â†’ Slack ã«å³æ™‚é€šçŸ¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

âœ… èª°ãŒ: `developer@example.com`
âœ… ã„ã¤: `14:32:08`ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
âœ… ãªãœ: `AuthorizeSecurityGroupIngress` API å‘¼ã³å‡ºã—
âœ… ä½•ã‚’: `0.0.0.0/0` ã‚’è¨±å¯ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰

---

## ğŸŒ å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TB
    A[AWS CloudTrail] --> B[Falco<br/>CloudTrail Plugin]
    B --> C[Falco Rules<br/>Engine]
    C --> D[Falco gRPC<br/>Output Stream]
    D --> E[TFDrift-Falco<br/>Subscriber]

    F[Terraform State<br/>S3/Local] --> E

    E --> G[Drift Engine]
    G --> H{Drift Detected?}

    H -->|Yes| I[Enrichment<br/>+ Context]
    H -->|No| J[Log Only]

    I --> K[Notification<br/>Manager]
    K --> L[Slack]
    K --> M[Discord]
    K --> N[Webhook]

    style E fill:#4A90E2
    style G fill:#FFA500
    style I fill:#50C878
    style B fill:#00B4AB
```

### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. **AWS Console ã§ãƒªã‚½ãƒ¼ã‚¹å¤‰æ›´**
   â†’ CloudTrail ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²

2. **Falco ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥**
   â†’ CloudTrail Plugin çµŒç”±ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

3. **TFDrift-Falco ãŒå—ä¿¡**
   â†’ Terraform State ã¨æ¯”è¼ƒ

4. **ãƒ‰ãƒªãƒ•ãƒˆåˆ¤å®š**
   â†’ å·®åˆ†ãŒã‚ã‚Œã°å³åº§ã«ã‚¢ãƒ©ãƒ¼ãƒˆ

5. **é€šçŸ¥é€ä¿¡**
   â†’ Slack / Discord / Webhook

---

## ğŸ’¡ ã¾ã¨ã‚

### ãªãœ Falco ã‚’æŒŸã‚€ã®ã‹ï¼Ÿ

**Terraform ã ã‘ã§ã¯ã€Œçµæœã€ã—ã‹åˆ†ã‹ã‚‰ãªã„ã€‚**
**Falco ãŒã‚ã‚‹ã“ã¨ã§ã€ŒåŸå› ã€ãŒè¦‹ãˆã‚‹ã€‚**

| ãƒ„ãƒ¼ãƒ« | å½¹å‰² |
|--------|------|
| **Terraform** | ã€Œã‚ã‚‹ã¹ãå§¿ã€ã‚’å®šç¾© |
| **Falco** | ã€Œå®Ÿéš›ã«èµ·ããŸè¡Œç‚ºã€ã‚’è¦³æ¸¬ |
| **TFDrift-Falco** | ä¸¡è€…ã‚’ç¿»è¨³ã—ã¦æ„å‘³ã‚’æŠ½å‡º |

### Falco ã®æœ¬è³ª

Falco ã¯å˜ãªã‚‹ãƒ­ã‚°åé›†ãƒ„ãƒ¼ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
**ã€Œè¡Œç‚ºã€ã‚’ã€Œæ„å›³ã€ã¨ã—ã¦è§£é‡ˆã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ³** ã§ã™ã€‚

- çŠ¶æ…‹ â†’ è¡Œç‚º
- å·®åˆ† â†’ æ„å›³
- ãƒªã‚½ãƒ¼ã‚¹ â†’ äºº

ã“ã®å¤‰æ›ãŒã‚ã‚‹ã‹ã‚‰ã€
**ã€Œèª°ãŒãƒ»ãªãœãƒ»ã„ã¤ã€ãŒè¦‹ãˆã‚‹** ã®ã§ã™ã€‚

---

## ğŸ”— ãƒªãƒ³ã‚¯

- **TFDrift-Falco ãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/higakikeita/tfdrift-falco
- **Falco å…¬å¼ã‚µã‚¤ãƒˆ**: https://falco.org/
- **Sysdig Community**: https://community.sysdig.com/

---

## ğŸ™ æœ€å¾Œã«

ã“ã®ç‰©èªãŒã€**ã€Œãªãœ Falco ãªã®ã‹ã€** ã®ç†è§£ã®ä¸€åŠ©ã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

æŠ€è¡“ã¯æ™‚ã«è¤‡é›‘ã§ã™ãŒã€æœ¬è³ªã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚

> **åœ°å›³ã¯ã€Œã‚ã‚‹ã¹ãå§¿ã€ã‚’èªã‚‹ã€‚**
> **ç›®æ’ƒè€…ã¯ã€Œèµ·ããŸè¡Œç‚ºã€ã‚’èªã‚‹ã€‚**

ä¸¡æ–¹ãŒã‚ã£ã¦ã€åˆã‚ã¦è¡—ã¯å®ˆã‚‰ã‚Œã‚‹ã€‚

---

**Written by [@keitah0322](https://x.com/keitah0322)**
**GitHub: [@higakikeita](https://github.com/higakikeita)**
**Project: [TFDrift-Falco](https://github.com/higakikeita/tfdrift-falco)**
